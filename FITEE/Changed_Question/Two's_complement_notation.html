<!DOCTYPE html>
<html lang="ja">
  <link rel="icon" href="https://avatars.githubusercontent.com/u/120705481?s=48&v=4" type="image/x-icon">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2ã®è£œæ•°è¡¨è¨˜ã‚¯ã‚¤ã‚º</title>
  <link rel="stylesheet" href="../../keep_out/inputQuestion.css">
  <audio id="se-correct" src="../../keep_out/correct.mp3" preload="auto"></audio>
  <audio id="se-wrong" src="../../keep_out/wrong.mp3" preload="auto"></audio>
  <audio id="se-start" src="../../keep_out/start.mp3" preload="auto"></audio>
  <audio id="se-end" src="../../keep_out/end.mp3" preload="auto"></audio>

</head>

<body>
    <div class="countdown-overlay" id="countdown-overlay">
        <div class="countdown-text" id="countdown-text">3</div>
    </div>

    <audio id="bgm" src="../../keep_out/BGM.mp3" loop></audio>
  <button id="bgm-toggle">â–¶ï¸ BGMã‚’å†ç”Ÿ</button>
    <div id="home" class="quiz-container">
        <h1>2ã®è£œæ•°è¡¨è¨˜ã‚¯ã‚¤ã‚º</h1>
        <p id="question-count">å…¨<span id="initial-question-count">5</span>å•ã§ã™ã€‚</p>
        <button id="startButton">é–‹å§‹</button>
        <a href="../FITEE.html" class="back-button">å•é¡Œé¸æŠã«æˆ»ã‚‹</a>
        <audio id="se-start" src="se_start.mp3"></audio>
        <audio id="se-correct" src="se_correct.mp3"></audio>
        <audio id="se-wrong" src="se_wrong.mp3"></audio>
        <audio id="se-end" src="se_end.mp3"></audio>
    </div>

    <div id="quiz" class="quiz-container" style="display: none;">
        </div>

    <script>

        const RANKING_KEY = "twosComplementRanking"; // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚­ãƒ¼ã‚’ç›´æ¥å®šç¾©
        const selectionPageUrl = "../FITEE.html"; // å•é¡Œé¸æŠãƒšãƒ¼ã‚¸ã¸ã®URLã‚’ç›´æ¥å®šç¾©

        let questions = []; // å•é¡Œã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹ãŸã‚ã€ç©ºã®ã¾ã¾
        let bgmToggleBtn;
        let bgm;
        let current = 0;
        let score = 0;
        let backClickCount = 0;
        const homeEl = document.getElementById("home");
        const quizEl = document.getElementById("quiz");
        const initialQuestionCountElement = document.getElementById("initial-question-count");
        const totalQuestionsToGenerate = 5; // ç”Ÿæˆã™ã‚‹å•é¡Œæ•°

        // åˆæœŸè¡¨ç¤ºã®å•é¡Œæ•°ã‚’è¨­å®š
        if (initialQuestionCountElement) {
            initialQuestionCountElement.textContent = totalQuestionsToGenerate;
        }

        document.addEventListener("DOMContentLoaded", () => {
            const questionCountElement = document.getElementById("question-count");
            if (questionCountElement) {
                // DOMContentLoadedæ™‚ç‚¹ã§ã¯ã€initial-question-countãŒè¨­å®šæ¸ˆã¿
                questionCountElement.textContent = `å…¨${totalQuestionsToGenerate}å•ã§ã™ã€‚`;
            }

            const backButtonHome = document.querySelector(".back-button");
            if (backButtonHome) {
                backButtonHome.addEventListener("click", function (e) {
                    e.preventDefault();
                    if (backClickCount === 0) {
                        alert("æœ¬å½“ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æˆ»ã‚Šã¾ã™ã€‚");
                        backClickCount++;
                    } else {
                        window.location.href = selectionPageUrl;
                    }
                });
            }

            bgmToggleBtn = document.getElementById("bgm-toggle");
            bgm = document.getElementById("bgm");
            if (bgmToggleBtn && bgm) {
                bgmToggleBtn.addEventListener("click", () => {
                    if (!bgm.paused) {
                        bgm.pause();
                        bgmToggleBtn.textContent = 'â–¶ï¸ BGMã‚’å†é–‹';
                    } else {
                        bgm.play();
                        bgmToggleBtn.textContent = 'â¸ï¸ BGMã‚’åœæ­¢';
                    }
                });
            }

            const startButton = document.getElementById("startButton");
            if (startButton) {
                startButton.addEventListener("click", startQuiz);
            }
        });

        function toHalfWidth(str) {
            return str.replace(/[ï¼-ï½]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/ã€€/g, ' ');
        }
        function normalizeInput(str) {
            return toHalfWidth(str.trim()).replace(/\s+/g, ' ');
        }
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- 2ã®è£œæ•°å¤‰æ›ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

        /**
         * 10é€²æ•°ã‚’æŒ‡å®šãƒ“ãƒƒãƒˆæ•°ã®2ã®è£œæ•°è¡¨ç¾ã«å¤‰æ›ã—ã¾ã™ã€‚
         * @param {number} decimal 10é€²æ•°
         * @param {number} bits ãƒ“ãƒƒãƒˆæ•°
         * @returns {string} 2ã®è£œæ•°è¡¨ç¾ã®ãƒã‚¤ãƒŠãƒªæ–‡å­—åˆ—
         */
        function decimalToTwosComplement(decimal, bits) {
            if (decimal >= 0) {
                let binary = decimal.toString(2);
                return binary.padStart(bits, '0');
            } else {
                let absDecimal = Math.abs(decimal);
                let binary = absDecimal.toString(2);
                binary = binary.padStart(bits, '0');

                let invertedBinary = binary.split('').map(bit => (bit === '0' ? '1' : '0')).join('');

                let carry = 1;
                let result = '';
                for (let i = bits - 1; i >= 0; i--) {
                    let sum = parseInt(invertedBinary[i]) + carry;
                    result = (sum % 2) + result;
                    carry = Math.floor(sum / 2);
                }
                return result;
            }
        }

        /**
         * æŒ‡å®šãƒ“ãƒƒãƒˆæ•°ã®2ã®è£œæ•°è¡¨ç¾ã‚’10é€²æ•°ã«å¤‰æ›ã—ã¾ã™ã€‚
         * @param {string} twosComplement 2ã®è£œæ•°è¡¨ç¾ã®ãƒã‚¤ãƒŠãƒªæ–‡å­—åˆ—
         * @returns {number} 10é€²æ•°
         */
        function twosComplementToDecimal(twosComplement) {
            const bits = twosComplement.length;
            if (twosComplement[0] === '0') {
                return parseInt(twosComplement, 2);
            } else {
                let inverted = twosComplement.split('').map(bit => (bit === '0' ? '1' : '0')).join('');
                let tempDecimal = parseInt(inverted, 2);
                return -(tempDecimal + 1);
            }
        }

        /**
         * ãƒ©ãƒ³ãƒ€ãƒ ãª2ã®è£œæ•°å•é¡Œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
         * @returns {object} å•é¡Œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ { q: å•é¡Œæ–‡, answer: æ­£è§£, explanation: è§£èª¬ }
         */
        function generateTwosComplementQuestion() {
            const bitsOptions = [4, 8, 16];
            const bits = bitsOptions[Math.floor(Math.random() * bitsOptions.length)];

            const maxPositive = Math.pow(2, bits - 1) - 1;
            const minNegative = -Math.pow(2, bits - 1);

            const questionType = Math.random() < 0.5 ? 'decimalToTwos' : 'twosToDecimal';

            let questionText;
            let correctAnswer;
            let explanationText;

            if (questionType === 'decimalToTwos') {
                const decimalNum = Math.floor(Math.random() * (maxPositive - minNegative + 1)) + minNegative;
                correctAnswer = decimalToTwosComplement(decimalNum, bits);
                questionText = `10é€²æ•° ${decimalNum} ã‚’ ${bits}ãƒ“ãƒƒãƒˆ ã®2ã®è£œæ•°è¡¨è¨˜ã«ã™ã‚‹ã¨ï¼Ÿ`;
                explanationText = `${decimalNum} ã‚’ ${bits}ãƒ“ãƒƒãƒˆã®2ã®è£œæ•°è¡¨è¨˜ã«å¤‰æ›ã—ã¾ã™ã€‚<br>`;
                if (decimalNum >= 0) {
                    explanationText += `æ­£ã®æ•°ãªã®ã§ã€ã¾ãš10é€²æ•° ${decimalNum} ã‚’2é€²æ•° (${decimalNum.toString(2)}) ã«å¤‰æ›ã—ã€${bits}ãƒ“ãƒƒãƒˆã«ãªã‚‹ã‚ˆã†ã«å…ˆé ­ã«0ã‚’åŸ‹ã‚ã¾ã™ã€‚`;
                } else {
                    explanationText += `è² ã®æ•°ãªã®ã§ã€ã¾ãšçµ¶å¯¾å€¤ ${Math.abs(decimalNum)} ã‚’2é€²æ•° (${Math.abs(decimalNum).toString(2)}) ã«å¤‰æ›ã—ã€${bits}ãƒ“ãƒƒãƒˆã«ãªã‚‹ã‚ˆã†ã«0ã‚’åŸ‹ã‚ã¾ã™ã€‚<br>`;
                    explanationText += `æ¬¡ã«ã€å…¨ã¦ã®ãƒ“ãƒƒãƒˆã‚’åè»¢ã•ã›ã€æœ€å¾Œã« 1 ã‚’åŠ ãˆã¾ã™ã€‚`;
                }

            } else {
                let binaryStr;
                let decimalCandidate;
                do {
                    binaryStr = '';
                    for (let i = 0; i < bits; i++) {
                        binaryStr += Math.random() < 0.5 ? '0' : '1';
                    }
                    decimalCandidate = twosComplementToDecimal(binaryStr);
                } while (decimalCandidate > maxPositive || decimalCandidate < minNegative);

                correctAnswer = String(decimalCandidate);
                questionText = `${bits}ãƒ“ãƒƒãƒˆ ã®2ã®è£œæ•°è¡¨è¨˜ ${binaryStr} ã¯10é€²æ•°ã§ä½•ï¼Ÿ`;
                explanationText = `${binaryStr}ã‚’10é€²æ•°ã«å¤‰æ›ã—ã¾ã™ã€‚<br>`;
                if (binaryStr[0] === '0') {
                    explanationText += `æœ€ä¸Šä½ãƒ“ãƒƒãƒˆãŒ0ãªã®ã§æ­£ã®æ•°ã§ã™ã€‚${binaryStr}ã‚’ç›´æ¥10é€²æ•°ã«å¤‰æ›ã—ã¾ã™ã€‚`;
                } else {
                    explanationText += `æœ€ä¸Šä½ãƒ“ãƒƒãƒˆãŒ1ãªã®ã§è² ã®æ•°ã§ã™ã€‚ã¾ãšå…¨ã¦ã®ãƒ“ãƒƒãƒˆã‚’åè»¢ã•ã›ã€1ã‚’åŠ ãˆã¦ã‹ã‚‰ãã®10é€²æ•°å€¤ã«è² ã®ç¬¦å·ã‚’ä»˜ã‘ã¾ã™ã€‚`;
                }
            }

            return {
                q: questionText,
                answer: correctAnswer,
                explanation: explanationText
            };
        }

        // --- ã‚¯ã‚¤ã‚ºé–‹å§‹å‡¦ç†ã®ä¿®æ­£ ---
        function startQuiz() {
            const startButton = document.getElementById("startButton");
            startButton.disabled = true;

            const seStart = document.getElementById('se-start');
            seStart.currentTime = 0;
            seStart.play();

            const countdownOverlay = document.getElementById('countdown-overlay');
            const countdownText = document.getElementById('countdown-text');
            countdownOverlay.style.display = 'flex';

            let count = 3;
            countdownText.textContent = count;

            const countdownTimer = setInterval(() => {
                count--;
                countdownText.textContent = count > 0 ? count : 'START!';
            }, 1000);

            setTimeout(() => {
                clearInterval(countdownTimer);
                countdownOverlay.style.display = 'none';

                if (bgmToggleBtn && bgmToggleBtn.textContent === "â–¶ï¸ BGMã‚’å†ç”Ÿ") {
                    bgm.play();
                    bgmToggleBtn.textContent = 'â¸ï¸ BGMã‚’åœæ­¢';
                }

                // ã“ã“ã§å‹•çš„ã«å•é¡Œã‚’ç”Ÿæˆã—ã€questionsé…åˆ—ã«ä»£å…¥
                questions = []; // æ—¢å­˜ã®questionsé…åˆ—ã‚’ã‚¯ãƒªã‚¢
                for (let i = 0; i < totalQuestionsToGenerate; i++) {
                    questions.push(generateTwosComplementQuestion());
                }
                
                // å•é¡Œæ•°ã‚’æ›´æ–° (DOMã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚è¨­å®šã•ã‚Œã‚‹ãŒã€å¿µã®ãŸã‚)
                const questionCountElement = document.getElementById("question-count");
                if (questionCountElement) {
                    questionCountElement.textContent = `å…¨${questions.length}å•ã§ã™ã€‚`;
                }

                shuffle(questions);
                current = 0;
                score = 0;
                homeEl.style.display = "none";
                quizEl.style.display = "block";
                showQuestion(current);
                startButton.disabled = false;
            }, 3500);
        }
        // --- ã‚¯ã‚¤ã‚ºé–‹å§‹å‡¦ç†ã®ä¿®æ­£ çµ‚ã‚ã‚Š ---

        // showQuestionä»¥ä¸‹ã®é–¢æ•°ã¯inputQuestion.jsã®æ—¢å­˜ã®ã¾ã¾ (å¤‰æ›´ãªã—)
        function showQuestion(index) {
            const q = questions[index];
            quizEl.innerHTML = "";

            const question = document.createElement("div");
            question.innerHTML = `<strong>Q${index + 1}:</strong> ${q.q}`;
            quizEl.appendChild(question);

            const input = document.createElement("textarea");
            input.placeholder = "ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„";
            quizEl.appendChild(input);

            const answerButton = document.createElement("button");
            answerButton.textContent = "è§£ç­”ã™ã‚‹";
            quizEl.appendChild(answerButton);

            const result = document.createElement("div");
            result.className = "result";
            quizEl.appendChild(result);

            const explanation = document.createElement("div");
            explanation.className = "explanation";
            quizEl.appendChild(explanation);

            const nextButton = document.createElement("button");
            nextButton.textContent = "æ¬¡ã¸";
            nextButton.style.display = "none";
            quizEl.appendChild(nextButton);

            const backButton = document.createElement("a");
            backButton.href = selectionPageUrl;
            backButton.textContent = "å•é¡Œé¸æŠã«æˆ»ã‚‹";
            backButton.className = "home-button";
            quizEl.appendChild(backButton);
            backButton.addEventListener("click", function (e) {
                e.preventDefault();
                if (backClickCount === 0) {
                    alert("æœ¬å½“ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æˆ»ã‚Šã¾ã™ã€‚");
                    backClickCount++;
                } else {
                    window.location.href = selectionPageUrl;
                }
            });

            let emptyClickCount = 0;
            answerButton.addEventListener("click", () => {
                const userInput = input.value.trim();
                if (userInput === "") {
                    emptyClickCount++;
                    if (emptyClickCount === 1) {
                        result.textContent = "ä½•ã‚‚å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨æ­£è§£ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
                        result.style.color = "black";
                        return;
                    }
                }

                input.disabled = true;
                const seCorrect = document.getElementById("se-correct");
                const seWrong = document.getElementById("se-wrong");

                const normalizedUser = normalizeInput(userInput);
                const normalizedAns = normalizeInput(q.answer);

                if (normalizedUser === normalizedAns) {
                    score++;
                    seCorrect.currentTime = 0;
                    seCorrect.play();
                    result.textContent = "â—‹ æ­£è§£ã§ã™ï¼";
                    result.classList.add("correct");
                    result.style.color = "green";
                } else {
                    seWrong.currentTime = 0;
                    seWrong.play();
                    result.innerHTML = `Ã— ä¸æ­£è§£ã§ã™ã€‚<br><strong>æ­£è§£ï¼š</strong><pre>${q.answer}</pre>`;
                    result.classList.add("wrong");
                    result.style.color = "red";
                }

                explanation.innerHTML = q.explanation;
                answerButton.style.display = "none";
                nextButton.style.display = "block";
            });

            nextButton.addEventListener("click", () => {
                setTimeout(() => {
                    current++;
                    backClickCount = 0;
                    if (current < questions.length) {
                        showQuestion(current);
                    } else {
                        const seEnd = document.getElementById('se-end');
                        seEnd.currentTime = 0;
                        seEnd.play();
                        quizEl.innerHTML = `<h2>ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼å…¨${questions.length}å•ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚<br><br>${score}å•æ­£è§£ã—ã¾ã—ãŸï¼</h2>`;
                        const today = new Date().toLocaleString();
                        const newRecord = { date: today, score: score };
                        let ranking = JSON.parse(localStorage.getItem(RANKING_KEY) || "[]");
                        ranking.push(newRecord);
                        ranking.sort((a, b) => b.score - a.score);
                        ranking = ranking.slice(0, 5);
                        localStorage.setItem(RANKING_KEY, JSON.stringify(ranking));

                        const rankingList = document.createElement("div");
                        rankingList.innerHTML = "<h3>ğŸ†æ­£è§£æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°(ãƒ­ãƒ¼ã‚«ãƒ«)</h3>";
                        ranking.forEach((r, i) => {
                            rankingList.innerHTML += `${i + 1}ä½: ${r.score}ç‚¹ï¼ˆ${r.date}ï¼‰<br>`;
                        });

                        const retryBtn = document.createElement("button");
                        retryBtn.textContent = "æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™";
                        retryBtn.onclick = () => startQuiz();

                        let resetClickCount = 0;
                        const resetBtn = document.createElement("button");
                        resetBtn.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ";
                        resetBtn.onclick = () => {
                            if (resetClickCount === 0) {
                                alert("æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚");
                                resetClickCount++;
                            } else {
                                localStorage.removeItem(RANKING_KEY);
                                location.reload();
                            }
                        };

                        quizEl.appendChild(backButton);
                        quizEl.appendChild(retryBtn);
                        quizEl.appendChild(rankingList);
                        quizEl.appendChild(resetBtn);
                    }
                }, 100);
            });
        }
    </script>
</body>
</html>