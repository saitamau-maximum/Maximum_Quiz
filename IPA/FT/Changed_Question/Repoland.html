<!DOCTYPE html>
<html lang="ja">
  <link rel="icon" href="https://avatars.githubusercontent.com/u/120705481?s=48&v=4" type="image/x-icon">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€†ãƒãƒ¼ãƒ©ãƒ³ãƒ‰è¨˜æ³•ã®å•é¡Œ</title>
  <link rel="stylesheet" href="../../../keep_out/inputQuestion.css">
  <audio id="se-correct" src="../../../keep_out/correct.mp3" preload="auto"></audio>
  <audio id="se-wrong" src="../../../keep_out/wrong.mp3" preload="auto"></audio>
   <audio id="se-start" src="../../../keep_out/start.mp3" preload="auto"></audio>
  <audio id="se-end" src="../../../keep_out/end.mp3" preload="auto"></audio>
</head>
<body>
  <audio id="bgm" src="../../../keep_out/BGM.mp3" loop></audio>
  <button id="bgm-toggle">â–¶ï¸ BGMã‚’å†ç”Ÿ</button>
  <div class="quiz-container" id="home">
    <h1>é€†ãƒãƒ¼ãƒ©ãƒ³ãƒ‰è¨˜æ³•ã®å•é¡Œ</h1>
    <p id="question-count">å•é¡Œæ•°ã‚’è¡¨ç¤º(å¤‰æ›´ä¸è¦)</p>
    <button id="startButton" onclick="startQuiz()">é–‹å§‹</button>
    <a href="../FITEE.html" class="back-button">å•é¡Œé¸æŠã«æˆ»ã‚‹</a>
  </div>

  <div class="quiz-container" id="quiz" style="display: none;"></div>
  <div id="countdown-overlay" class="countdown-overlay">
  <div id="countdown-text" class="countdown-text"></div>
  </div>
  <script>
  const RANKING_KEY = "repoland_in_quiz_ranking";
  const questions = [];

function evaluateRPN(expression) {
  const stack = [];
  const tokens = expression.split(' ');

  for (const token of tokens) {
    if (!isNaN(parseFloat(token)) && isFinite(token)) {
      stack.push(parseFloat(token));
    } else {
      const operand2 = stack.pop();
      const operand1 = stack.pop();

      switch (token) {
        case '+':
          stack.push(operand1 + operand2);
          break;
        case '-':
          stack.push(operand1 - operand2);
          break;
        case '*':
          stack.push(operand1 * operand2);
          break;
        case '/':
          if (operand2 === 0) throw new Error("ã‚¼ãƒ­é™¤ç®—ã‚¨ãƒ©ãƒ¼");
          stack.push(Math.floor(operand1 / operand2));
          break;
        default:
          throw new Error("ç„¡åŠ¹ãªæ¼”ç®—å­: " + token);
      }
    }
  }
  return stack.pop();
}

function createRPNQuestion() {
  const patterns = [
    { exprTemplate: "N1 N2 + N3 *", operators: ['+', '*'], infixTemplate: "(N1 + N2) * N3" },
    { exprTemplate: "N1 N2 N3 - /", operators: ['/', '-'], infixTemplate: "N1 / (N2 - N3)" },
    { exprTemplate: "N1 N2 * N3 +", operators: ['*', '+'], infixTemplate: "(N1 * N2) + N3" },
    { exprTemplate: "N1 N2 N3 + *", operators: ['+', '*'], infixTemplate: "N1 * (N2 + N3)" },
    { exprTemplate: "N1 N2 - N3 +", operators: ['-', '+'], infixTemplate: "(N1 - N2) + N3" },
    { exprTemplate: "N1 N2 + N3 -", operators: ['+', '-'], infixTemplate: "(N1 + N2) - N3" },
    { exprTemplate: "N1 N2 N3 * /", operators: ['*', '/'], infixTemplate: "N1 / (N2 * N3)" },
    { exprTemplate: "N1 N2 / N3 +", operators: ['/', '+'], infixTemplate: "(N1 / N2) + N3" },
    { exprTemplate: "N1 N2 / N3 + N4 *", operators: ['/', '+', '*'], infixTemplate: "( (N1 / N2) + N3 ) * N4" },
    { exprTemplate: "N1 N2 - N3 - N4 /", operators: ['-', '/'], infixTemplate: "( (N1 - N2) - N3 ) / N4" },
    { exprTemplate: "N1 N2 * N3 + N4 -", operators: ['*', '+', '-'], infixTemplate: "( (N1 * N2) + N3 ) - N4" },
    { exprTemplate: "N1 N2 + N3 * N4 /", operators: ['+', '*', '/'], infixTemplate: "( (N1 + N2) * N3 ) / N4" },
    { exprTemplate: "N1 N2 - N3 + N4 *", operators: ['-', '+', '*'], infixTemplate: "( (N1 - N2) + N3 ) * N4" },
    { exprTemplate: "N1 N2 / N3 - N4 +", operators: ['/', '-', '+'], infixTemplate: "( (N1 / N2) - N3 ) + N4" }
  ];

  const selectedPattern = patterns[Math.floor(Math.random() * patterns.length)];
  let expr = selectedPattern.exprTemplate;
  let infixExpr = selectedPattern.infixTemplate;

  const numMap = {};

  const numCount = (expr.match(/N/g) || []).length;
  for (let i = 0; i < numCount; i++) {
    let num = Math.floor(Math.random() * 10) + 1;
    expr = expr.replace('N' + (i + 1), num);
    infixExpr = infixExpr.replace('N' + (i + 1), num);
  }

  let correctAnswer;
  try {
    correctAnswer = evaluateRPN(expr);
  } catch (e) {
    console.error("RPNè¨ˆç®—ã‚¨ãƒ©ãƒ¼:", e);
    return null;
  }

  const questionText = `æ¬¡ã®é€†ãƒãƒ¼ãƒ©ãƒ³ãƒ‰è¨˜æ³•ï¼ˆå¾Œç½®è¨˜æ³•ï¼‰ã®è¨ˆç®—çµæœã‚’åŠè§’ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\nï¼ˆå‰²ã‚Šåˆ‡ã‚Œãªã„å ´åˆã¯å°æ•°ç‚¹ä»¥ä¸‹ã‚’åˆ‡ã‚Šæ¨ã¦ã¦ãã ã•ã„ï¼‰\n<pre>${expr}</pre>`;
  const correctAnswerStr = String(correctAnswer);

  return {
    q: questionText,
    answer: correctAnswerStr,
    explanation: `è§£èª¬ï¼šé€†ãƒãƒ¼ãƒ©ãƒ³ãƒ‰è¨˜æ³• ${expr} ã‚’ä¸­ç½®è¨˜æ³•ã«ç›´ã™ã¨ ${infixExpr} ã§ã™ã€‚ã“ã‚Œã‚’è¨ˆç®—ã™ã‚‹ã¨ ${correctAnswerStr} ã«ãªã‚Šã¾ã™ã€‚`
  };
}

document.addEventListener("DOMContentLoaded", () => {
    const questionCountElement = document.getElementById("question-count");
    if (questionCountElement) {
      questionCountElement.textContent = `å…¨5å•ã§ã™ã€‚`;
    }
});

function toHalfWidth(str) {
  return str.replace(/[ï¼-ï½]/g, function(s) {
    return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
  }).replace(/ã€€/g, ' ');
}

function normalizeInput(str) {
  return toHalfWidth(str.trim()).replace(/\s+/g, ' ');
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

let current = 0;
let score = 0;
let backClickCount = 0;

function escapeHTMLExceptBR(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/&lt;br&gt;/g, "<br>")
    .replace(/&lt;pre&gt;/g, "<pre>")
    .replace(/&lt;\/pre&gt;/g, "</pre>");
}

const backButtonHome = document.querySelector(".back-button");
if (backButtonHome) {
  backButtonHome.addEventListener("click", function(e) {
    e.preventDefault();
    if (backClickCount === 0) {
      alert("æœ¬å½“ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æˆ»ã‚Šã¾ã™ã€‚");
      backClickCount++;
    } else {
      window.location.href = "../FITEE.html";
    }
  });
}

const homeEl = document.getElementById("home");
const quizEl = document.getElementById("quiz");

function startQuiz() {

  const startButton = document.getElementById("startButton");
  startButton.disabled = true;

  const seStart = document.getElementById('se-start');
  seStart.currentTime = 0;
  seStart.play();

  const countdownOverlay = document.getElementById('countdown-overlay');
  const countdownText = document.getElementById('countdown-text');

  countdownOverlay.style.display = 'flex';

  let count = 3;
  countdownText.textContent = count;

  const countdownTimer = setInterval(() => {
    count--;
    if (count > 0) {
      countdownText.textContent = count;
    } else {
      countdownText.textContent = 'START!';
    }
  }, 1000);

  setTimeout(() => {
    clearInterval(countdownTimer);
    countdownOverlay.style.display = 'none';

    if(bgmToggleBtn.textContent == "â–¶ï¸ BGMã‚’å†ç”Ÿ") {
      document.getElementById('bgm').play();
      bgmToggleBtn.textContent = 'â¸ï¸ BGMã‚’åœæ­¢';
    }

    questions.length = 0;
    const numberOfQuestionsToGenerate = 5;                    //å•é¡Œæ•°èª¿æ•´å ´æ‰€
    for (let i = 0; i < numberOfQuestionsToGenerate; i++) {
        const rpnQuestion = createRPNQuestion();
        if (rpnQuestion) {
            questions.push(rpnQuestion);
        }
    }
    
    shuffle(questions);

    current = 0;
    score = 0;
    homeEl.style.display = "none";
    quizEl.style.display = "block";
    showQuestion(current);
    startButton.disabled = false;
  }, 3500);
}

function showQuestion(index) {
  const q = questions[index];

  quizEl.innerHTML = "";

  const question = document.createElement("div");
  question.innerHTML = `<strong>Q${index + 1}:</strong> ${q.q}`;
  quizEl.appendChild(question);

  const input = document.createElement("textarea");
  input.placeholder = "ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„";
  quizEl.appendChild(input);

  const answerButton = document.createElement("button");
  answerButton.textContent = "è§£ç­”ã™ã‚‹";
  quizEl.appendChild(answerButton);

  const result = document.createElement("div");
  result.className = "result";
  quizEl.appendChild(result);

  const explanation = document.createElement("div");
  explanation.className = "explanation";
  quizEl.appendChild(explanation);

  const nextButton = document.createElement("button");
  nextButton.textContent = "æ¬¡ã¸";
  nextButton.style.display = "none";
  quizEl.appendChild(nextButton);

  const backButton = document.createElement("a");
  backButton.href = "../FITEE.html";
  backButton.textContent = "å•é¡Œé¸æŠã«æˆ»ã‚‹";
  backButton.className = "home-button";
  quizEl.appendChild(backButton);
  backButton.addEventListener("click", function(e) {
    e.preventDefault();
    if (backClickCount === 0) {
      alert("æœ¬å½“ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æˆ»ã‚Šã¾ã™ã€‚");
      backClickCount++;
    } else {
      window.location.href = "../FITEE.html";
    }
  });

  let emptyClickCount = 0;

  answerButton.addEventListener("click", () => {
    const userInput = input.value.trim();

    if (userInput === "") {
      emptyClickCount++;
      if (emptyClickCount === 1) {
        result.textContent = "ä½•ã‚‚å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨æ­£è§£ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
        result.style.color = "black";
        return;
      }
    }

    input.disabled = true;
    const seCorrect = document.getElementById("se-correct");
    const seWrong = document.getElementById("se-wrong");

    const normalizedUser = normalizeInput(userInput);
    const normalizedAns = normalizeInput(q.answer);
    if (normalizedUser === normalizedAns) {
      score++;
      seCorrect.currentTime = 0;
      seCorrect.play();
      result.textContent = "â—‹ æ­£è§£ã§ã™ï¼";
      result.classList.add("correct");
      result.style.color = "green";
      explanation.innerHTML = q.explanation;
    } else {
      seWrong.currentTime = 0;
      seWrong.play();
      result.innerHTML = `Ã— ä¸æ­£è§£ã§ã™ã€‚<br><strong>æ­£è§£ï¼š</strong><pre>${q.answer}</pre>`;
      result.classList.add("wrong");
      result.style.color = "red";
      explanation.innerHTML = q.explanation;
    }

    answerButton.style.display = "none";
    nextButton.style.display = "block";
  });

  nextButton.addEventListener("click", () => {
    setTimeout(() => {
      current++;
      backClickCount = 0;
      if (current < questions.length) {
        showQuestion(current);
      } else {
        const seEnd = document.getElementById('se-end');
        seEnd.currentTime = 0;
        seEnd.play();
        quizEl.innerHTML = `<h2>ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼å…¨${questions.length}å•ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚<br><br>${score}å•æ­£è§£ã—ã¾ã—ãŸï¼</h2>`;
        const today = new Date().toLocaleString();
        const newRecord = { date: today, score: score };

        let ranking = JSON.parse(localStorage.getItem(RANKING_KEY) || "[]");
        ranking.push(newRecord);

        ranking.sort((a, b) => b.score - a.score);
        ranking = ranking.slice(0, 5);

        localStorage.setItem(RANKING_KEY, JSON.stringify(ranking));

        const rankingList = document.createElement("div");
        rankingList.innerHTML = "<h3>ğŸ†æ­£è§£æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°(ãƒ­ãƒ¼ã‚«ãƒ«)</h3>";

        ranking.forEach((r, i) => {
            rankingList.innerHTML += `${i + 1}ä½: ${r.score}ç‚¹ï¼ˆ${r.date}ï¼‰<br>`;
        });

        const retryBtn = document.createElement("button");
        retryBtn.textContent = "æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™";
        retryBtn.onclick = () => {
          startQuiz();
        };

        let resetClickCount = 0;

        const resetBtn = document.createElement("button");
        resetBtn.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ";
        resetBtn.onclick = () => {
        if (resetClickCount === 0) {
            alert("æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚");
            resetClickCount++;
          } else {
              localStorage.removeItem(RANKING_KEY);
              location.reload();
          }
        };
        const backBtn = document.createElement("a");
        backBtn.href = "../FITEE.html";
        backBtn.textContent = "å•é¡Œé¸æŠã«æˆ»ã‚‹";
        backBtn.className = "home-button";
        quizEl.appendChild(backBtn);
        quizEl.appendChild(retryBtn);
        quizEl.appendChild(rankingList);
        quizEl.appendChild(resetBtn);
      }
    }, 100);
  });
}

const bgm = document.getElementById('bgm');
const bgmToggleBtn = document.getElementById('bgm-toggle');

bgmToggleBtn.addEventListener('click', () => {
  if (!bgm.paused) {
    bgm.pause();
    bgmToggleBtn.textContent = 'â–¶ï¸ BGMã‚’å†é–‹';
  } else {
    bgm.play();
    bgmToggleBtn.textContent = 'â¸ï¸ BGMã‚’åœæ­¢';
  }
});
  </script>
</body>
</html>
